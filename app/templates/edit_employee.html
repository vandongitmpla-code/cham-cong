{% extends "base.html" %}
{% block title %}S·ª≠a Nh√¢n vi√™n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/form_system.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/employees.css') }}">
{% endblock %}

{% block content %}
<div class="section-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="section-title">S·ª≠a th√¥ng tin nh√¢n vi√™n</h2>
      <p class="text-muted mb-0">C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n v√† ch·∫•m c√¥ng</p>
    </div>
    <a href="{{ url_for('main.employees') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
  </div>

  <form method="post" class="form-system">
    <div class="form-section">
      <h3 class="form-section-title">Th√¥ng tin c∆° b·∫£n</h3>
      
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">M√£ s·ªë nh√¢n vi√™n</label>
            <input type="text" name="code" class="form-control" value="{{ emp.code }}" required
                   placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">H·ªç v√† t√™n</label>
            <input type="text" name="name" class="form-control" value="{{ emp.name }}" required
                   placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label">T·ªï</label>
            <input type="text" name="team" class="form-control" value="{{ emp.team }}"
                   placeholder="V√≠ d·ª•: T·ªï 1">
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label">Ph√≤ng ban</label>
            <input type="text" name="department" class="form-control" value="{{ emp.department }}"
                   placeholder="V√≠ d·ª•: K·ªπ thu·∫≠t">
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label">Lo·∫°i h·ª£p ƒë·ªìng</label>
            <input type="text" name="contract_type" class="form-control" value="{{ emp.contract_type }}"
                   placeholder="V√≠ d·ª•: Ch√≠nh th·ª©c">
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="form-section-title">Th√¥ng tin ch·∫•m c√¥ng & b·∫£o hi·ªÉm</h3>
      
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">M√£ ch·∫•m c√¥ng</label>
            <input type="text" name="att_code" class="form-control" value="{{ emp.att_code or '' }}"
                   placeholder="Nh·∫≠p m√£ m√°y ch·∫•m c√¥ng">
            <div class="form-text">M√£ s·ª≠ d·ª•ng cho m√°y ch·∫•m c√¥ng</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Th√°ng b·∫Øt ƒë·∫ßu l√†m vi·ªác</label>
            <div class="month-input-wrapper">
              <input type="month" name="start_month" id="editStartMonth" 
                     class="form-control" 
                     value="{{ emp.start_month or '' }}"
                     onchange="updateEditInsuranceMonth()">
            </div>
          </div>
        </div>
      </div>

      <!-- Hi·ªÉn th·ªã th√°ng b·∫£o hi·ªÉm -->
      <div class="row">
        <div class="col-12">
          <div id="editInsuranceLabel">
            {% if emp.insurance_start_month %}
            <div class="insurance-display vietnamese">
              <i class="bi bi-shield-check me-2"></i>
              B·∫Øt ƒë·∫ßu ƒë√≥ng b·∫£o hi·ªÉm t·ª´: 
              <strong>
                {% set month = emp.insurance_start_month[5:7] %}
                {% set year = emp.insurance_start_month[:4] %}
                {% set month_names = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'] %}
                {{ month_names[month|int - 1] }} nƒÉm {{ year }}
              </strong>
            </div>
            {% else %}
            <div class="insurance-display vietnamese text-muted">
              <i class="bi bi-shield-exclamation me-2"></i>
              Ch∆∞a c√≥ th√¥ng tin b·∫£o hi·ªÉm
            </div>
            {% endif %}
          </div>
          <input type="hidden" name="insurance_start_month" id="editInsuranceMonth" value="{{ emp.insurance_start_month or '' }}">
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-form btn-form-primary">
        <i class="bi bi-check-circle"></i> C·∫≠p nh·∫≠t th√¥ng tin
      </button>
      <a href="{{ url_for('main.employees') }}" class="btn-form btn-form-secondary">
        <i class="bi bi-x-circle"></i> H·ªßy b·ªè
      </a>
    </div>
  </form>
</div>

<script>
function updateEditInsuranceMonth() {
    const startMonthInput = document.getElementById('editStartMonth');
    const insuranceMonthInput = document.getElementById('editInsuranceMonth');
    const insuranceLabel = document.getElementById('editInsuranceLabel');
    
    if (startMonthInput.value) {
        // T√≠nh th√°ng b·∫£o hi·ªÉm (th√°ng l√†m vi·ªác + 1)
        const startDate = new Date(startMonthInput.value + '-01');
        startDate.setMonth(startDate.getMonth() + 1);
        
        const insuranceYear = startDate.getFullYear();
        const insuranceMonth = String(startDate.getMonth() + 1).padStart(2, '0');
        const insuranceDate = `${insuranceYear}-${insuranceMonth}`;
        
        insuranceMonthInput.value = insuranceDate;
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 
                           'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
        const displayText = `üè¢ B·∫Øt ƒë·∫ßu ƒë√≥ng b·∫£o hi·ªÉm t·ª´: <strong>${monthNames[insuranceMonth - 1]} nƒÉm ${insuranceYear}</strong>`;
        
        insuranceLabel.innerHTML = `<div class="insurance-display vietnamese">${displayText}</div>`;
    } else {
        insuranceMonthInput.value = '';
        insuranceLabel.innerHTML = '<div class="insurance-display vietnamese text-muted"><i class="bi bi-shield-exclamation me-2"></i>Ch∆∞a c√≥ th√¥ng tin b·∫£o hi·ªÉm</div>';
    }
}

// Kh·ªüi t·∫°o khi trang load
document.addEventListener('DOMContentLoaded', function() {
    updateEditInsuranceMonth();
});
</script>
{% endblock %}