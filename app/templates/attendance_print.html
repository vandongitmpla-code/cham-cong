{% extends "base.html" %}

{% block title %}B·∫£ng ch·∫•m c√¥ng in k√Ω{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance_print.css') }}">
{% endblock %}

{% block content %}
  <!-- N√∫t in -->
  <div class="mb-3 text-end">
    <button class="btn btn-primary" onclick="window.print()">
      <i class="bi bi-printer"></i> In b·∫£ng
    </button>
  </div>

<div class="print-container">

  <!-- Th√¥ng tin c√¥ng ty -->
  <table class="table table-borderless w-100 mb-1">
    <tr>
      <td class="text-start"><strong>T√™n c√¥ng ty:</strong> {{ company.name }}</td>
    </tr>
    <tr>
      <td class="text-start"><strong>M√£ s·ªë thu·∫ø:</strong> {{ company.tax }}</td>
    </tr>
    <tr>
      <td class="text-start"><strong>ƒê·ªãa ch·ªâ:</strong> {{ company.address }}</td>
    </tr>
    <tr>
      <td class="text-center fw-bold fs-6">{{ company.title }}</td>
    </tr>
  </table>

<!-- B·∫£ng ch·∫•m c√¥ng -->
<div class="table-responsive">
  <table class="table table-bordered text-center align-middle">
    <thead class="table-light">
      <tr>
        {% for col in cols %}
        <th>{{ col }}</th>
        {% endfor %}
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        {% for i in range(row|length - 1) %}
          {% set colname = cols[i] %}
          {% set cell = row[i] %}

          {% if colname == "S·ªë ng√†y/gi·ªù l√†m vi·ªác th·ª±c t·∫ø trong th√°ng" %}
          <td class="adjustable-cell position-relative" 
              style="min-width: 120px; cursor: pointer;"
              onmouseenter="showAdjustmentButtons(this)" 
              onmouseleave="hideAdjustmentButtons(this)">
            
            {{ cell }}
  
            <div class="adjustment-buttons" style="display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%);">
              
              <!-- ‚úÖ N√öT "+" - CH·ªà HI·ªÜN KHI CH∆ØA ƒêI·ªÄU CH·ªàNH V√Ä C√ì TƒÇNG CA -->
              {% if row[-1].has_overtime and not row[-1].has_adjustment %}
              <i class="bi bi-plus-circle-fill text-success me-1 adjustment-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="G·ªôp ng√†y tƒÉng ca"
                style="cursor:pointer; font-size: 16px;"
                data-employee-code="{{ row[1] }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-original-days="{{ row[-1].original_days }}"
                data-actual-days="{{ row[8] }}"
                data-overtime-hours="{{ row[-1].tang_ca_nghi_ban_dau }}"
                data-current-absence="{{ row[-1].ngay_vang_ban_dau }}"
                data-standard-days="{{ row[-1].standard_days or 26 }}"
                data-ngay-nghi-phep-nam="{{ row[-1].ngay_nghi_phep_nam_da_dung }}"
                data-filename="{{ filename }}">  
              </i>
              {% endif %}
              
              <!-- ‚úÖ N√öT "-" - CH·ªà HI·ªÜN KHI ƒê√É ƒêI·ªÄU CH·ªàNH -->
              {% if row[-1].has_adjustment %}
              <i class="bi bi-dash-circle-fill text-danger reset-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc"
                style="cursor:pointer; font-size: 16px;"
                data-employee-code="{{ row[1] }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-filename="{{ filename }}">
              </i>
              {% endif %}
              
            </div>
          </td>

          {% elif colname == "S·ªë ng√†y ngh·ªâ ph√©p nƒÉm" %}
          <td class="position-relative leave-cell" 
              style="min-width: 120px; cursor: pointer;"
              onmouseenter="showLeaveButtons(this)" 
              onmouseleave="hideLeaveButtons(this)"
              data-bs-toggle="tooltip" 
              data-bs-placement="top"
              data-bs-html="true"
              data-bs-title="
                  <div class='text-start small'>
                      <strong>Chi ti·∫øt ph√©p nƒÉm:</strong><br>
                      - ƒê√£ d√πng <strong class='text-primary'>{{ row[6] }}</strong> ng√†y ph√©p nƒÉm<br>
                      {% if row[-1].has_adjustment %}
                      - ƒê√£ g·ªôp <strong class='text-success'>{{ (row[-1].adjustment_info / 8) | round(1) }}</strong> ng√†y CN<br>
                      {% else %}
                      - C√≥ th·ªÉ g·ªôp <strong class='text-warning'>{{ (row[-1].tang_ca_nghi_ban_dau / 8) | round(1) }}</strong> ng√†y CN<br>
                      {% endif %}
                      - Ph√©p nƒÉm c√≤n l·∫°i: <strong class='text-info'>{{ row[14] }}</strong> ng√†y
                  </div>
              ">
            
            <span class="leave-days">{{ cell }}</span>
            
            <div class="leave-buttons" style="display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%);">

              <!-- ‚úÖ N√öT "+" - LU√îN HI·ªÜN KHI C√ì QUY·ªÄN S·ª¨ D·ª§NG PH√âP -->
              {% if row[-1].so_thang_duoc_huong > 0 %}
              <i class="bi bi-plus-circle-fill text-success me-1 leave-add-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Th√™m ng√†y ph√©p nƒÉm"
                style="cursor:pointer; font-size: 16px;"
                data-employee-id="{{ row[-1].employee_id }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-max-leave="{{ row[-1].so_thang_duoc_huong }}"
                data-current-leave="{{ cell }}"
                data-current-absence="{{ row[-1].ngay_vang_ban_dau }}"
                data-filename="{{ filename }}">
              </i>
              {% endif %}
              
              <!-- ‚úÖ N√öT "-" - CH·ªà HI·ªÜN KHI ƒê√É C√ì PH√âP NƒÇM -->
              {% if cell > 0 %}
              <i class="bi bi-dash-circle-fill text-danger leave-reset-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Reset ng√†y ph√©p nƒÉm"
                style="cursor:pointer; font-size: 16px;"
                data-employee-id="{{ row[-1].employee_id }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-filename="{{ filename }}">
              </i>
              {% endif %}

            </div>
          </td>

          {% elif colname == "S·ªë ng√†y ngh·ªâ kh√¥ng l∆∞∆°ng" %}
          <td class="fw-bold absence-cell" 
              data-bs-toggle="tooltip" 
              data-bs-placement="top"
              data-bs-html="true"
              data-bs-title="
                  <div class='text-start small'>
                      <strong>üìä Chi ti·∫øt ng√†y ngh·ªâ kh√¥ng l∆∞∆°ng:</strong><br>
                      - Ng√†y ngh·ªâ g·ªëc: <strong class='text-danger'>{{ row[-1].ngay_vang_ban_dau }}</strong> ng√†y<br>
                      - ƒê√£ d√πng ph√©p nƒÉm: <strong class='text-primary'>{{ row[-1].ngay_nghi_phep_nam_da_dung }}</strong> ng√†y<br>
                      {% if row[-1].has_adjustment %}
                      - ƒê√£ b√π b·∫±ng tƒÉng ca: <strong class='text-success'>{{ (row[-1].adjustment_info / 8) | round(1) }}</strong> ng√†y<br>
                      {% else %}
                      - C√≥ th·ªÉ b√π b·∫±ng tƒÉng ca: <strong class='text-warning'>{{ (row[-1].tang_ca_nghi_ban_dau / 8) | round(1) }}</strong> ng√†y<br>
                      {% endif %}
                      - <strong>Ng√†y ngh·ªâ cu·ªëi: {{ cell }} ng√†y</strong>
                  </div>
              ">
              {{ cell }}
          </td>

          {% elif colname == "B·∫Øt ƒë·∫ßu t√≠nh ph√©p t·ª´ th√°ng" %}
            <td class="text-info fw-bold">
              {{ cell }}
            </td>

          {% elif colname == "S·ªë ng√†y ph√©p c√≤n t·ªìn" %}
          {% with 
              cell=cell,
              metadata=row[-1],
              employee_name=row[2],
              period=period,
              filename=filename
          %}
            {% include "_remaining_leave_cell.html" %}
          {% endwith %}

          {% elif colname in ["S·ªë gi·ªù l√†m vi·ªác tƒÉng ca (ng√†y ngh·ªâ h√†ng tu·∫ßn)", 
                             "S·ªë gi·ªù l√†m vi·ªác tƒÉng ca (ng√†y l·ªÖ)",
                             "S·ªë gi·ªù l√†m vi·ªác tƒÉng ca (ng√†y l√†m trong tu·∫ßn)"] %}
            <td class="fw-bold text-primary">
              {{ cell }}
            </td>

          {% elif colname == "Ghi ch√∫" %}
            <td class="note-cell" data-emp="{{ row[1] }}">
              {% if cell == "ICON_ONLY" or (cell is string and cell.endswith("|||ICON")) %}
                {% if cell != "ICON_ONLY" %}
                  {{ cell.replace("|||ICON", "") }}
                {% endif %}
                <i class="bi bi-pencil-square text-primary ms-1 note-icon"
                  title="Th√™m ghi ch√∫"
                  style="cursor:pointer;"></i>
                <input type="text"
                      class="note-input form-control form-control-sm mt-1 d-none"
                      placeholder="Nh·∫≠p ghi ch√∫...">
              {% else %}
                {{ cell }}
              {% endif %}
            </td>

          {% else %}
            <td>{{ cell }}</td>
          {% endif %}
        {% endfor %}

        <td>
          <i class="bi bi-eye text-info btn-detail"
            style="cursor:pointer;"
            data-emp='{{ row[-1] | tojson | safe }}'
            title="Xem chi ti·∫øt"></i>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  <!-- ‚úÖ TH√äM: Ph·∫ßn gi·∫£i th√≠ch c√¥ng th·ª©c -->
  <div class="mt-3 p-3 bg-light border rounded">
    <h6>Gi·∫£i th√≠ch c√¥ng th·ª©c:</h6>
    <ul class="small mb-0">
      <li><strong>Ng√†y c√¥ng th·ª±c t·∫ø</strong> = Ng√†y c√¥ng g·ªëc + Ph√©p nƒÉm ƒë√£ d√πng + TƒÉng ca ƒë√£ b√π</li>
      <li><strong>Ng√†y ngh·ªâ cu·ªëi</strong> = Ng√†y ngh·ªâ g·ªëc - Ph√©p nƒÉm ƒë√£ d√πng - TƒÉng ca ƒë√£ b√π</li>
      <li><strong>Gi·ªõi h·∫°n:</strong> Ng√†y c√¥ng th·ª±c t·∫ø kh√¥ng v∆∞·ª£t qu√° ng√†y c√¥ng chu·∫©n</li>
    </ul>
  </div>
</div>



<!-- Modal chi ti·∫øt -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h3 id="modalTitle"></h3>
    <div id="modalTableWrapper"></div>
  </div>
</div>

<!-- ‚úÖ C·∫¨P NH·∫¨T: Modal x√°c nh·∫≠n g·ªôp tƒÉng ca v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß -->
<div class="modal fade" id="adjustmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">G·ªôp ng√†y tƒÉng ca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ mu·ªën g·ªôp gi·ªù tƒÉng ca ch·ªß nh·∫≠t v√†o ng√†y c√¥ng cho <strong id="modalEmployeeName"></strong>?</p>
        
        <div class="adjustment-details">
          <table class="table table-sm">
            <tr>
              <td><strong>Ng√†y c√¥ng hi·ªán t·∫°i:</strong></td>
              <td id="modalCurrentDays"></td>
            </tr>
            <tr>
              <td><strong>Ng√†y ngh·ªâ hi·ªán t·∫°i:</strong></td>
              <td id="modalCurrentAbsence"></td>
            </tr>
            <tr>
              <td><strong>Ph√©p nƒÉm ƒë√£ d√πng:</strong></td>
              <td id="modalPhepNamUsed"></td>
            </tr>
            <tr>
              <td><strong>Gi·ªù tƒÉng ca c√≥ th·ªÉ g·ªôp:</strong></td>
              <td id="modalOvertimeHours"></td>
            </tr>
            <tr class="table-success">
              <td><strong>Ng√†y c√¥ng sau g·ªôp:</strong></td>
              <td id="modalAdjustedDays" class="text-success fw-bold"></td>
            </tr>
            <tr class="table-info">
              <td><strong>Ng√†y ngh·ªâ sau g·ªôp:</strong></td>
              <td id="modalNewAbsence" class="text-info fw-bold"></td>
            </tr>
            <tr class="table-warning">
              <td><strong>Gi·ªù tƒÉng ca c√≤n l·∫°i:</strong></td>
              <td id="modalRemainingHours" class="text-warning fw-bold"></td>
            </tr>
          </table>
        </div>
        
        <div class="alert alert-info mt-3">
          <small>
            <strong>C√¥ng th·ª©c:</strong> Ng√†y c√¥ng cu·ªëi = Ng√†y c√¥ng ban ƒë·∫ßu + Ph√©p nƒÉm + TƒÉng ca b√π<br>
            <strong>Gi·ªõi h·∫°n:</strong> Kh√¥ng v∆∞·ª£t qu√° ng√†y c√¥ng chu·∫©n ({{ rows[0][-1].standard_days if rows else 26 }} ng√†y)
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kh√¥ng</button>
        <button type="button" class="btn btn-primary" id="confirmAdjustmentBtn" 
        onclick="window.handleConfirmAdjustment()"> C√≥, √°p d·ª•ng
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ B·ªî SUNG: Modal x√°c nh·∫≠n reset -->
<div class="modal fade" id="resetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ mu·ªën kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc cho <strong id="resetEmployeeName"></strong>?</p>
        <p class="text-muted">D·ªØ li·ªáu ƒëi·ªÅu ch·ªânh s·∫Ω b·ªã x√≥a v√† kh√¥i ph·ª•c v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kh√¥ng</button>
        <button type="button" class="btn btn-danger" id="confirmReset">C√≥, kh√¥i ph·ª•c</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal th√™m ph√©p nƒÉm -->
<div class="modal fade" id="leaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m ng√†y ph√©p nƒÉm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Nh√¢n vi√™n: <strong id="leaveEmployeeName"></strong></p>
                <div class="mb-3">
                    <label class="form-label">S·ªë ng√†y ph√©p nƒÉm s·ª≠ d·ª•ng:</label>
                    <input type="number" class="form-control" id="leaveDaysInput" 
                           step="0.5" min="0" max="0">
                    <div class="form-text">S·ªë ng√†y t·ªëi ƒëa c√≥ th·ªÉ s·ª≠ d·ª•ng: <span id="maxLeaveDays">0</span> ng√†y</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmLeave">Xong</button>
            </div>
        </div>
    </div>
</div>

<!-- Form ·∫©n cho ph√©p nƒÉm -->
<form id="leaveForm" method="POST" action="{{ url_for('main.update_paid_leave') }}" style="display: none;">
    <input type="hidden" name="employee_id" id="formEmployeeId">
    <input type="hidden" name="period" id="formLeavePeriod">
    <input type="hidden" name="leave_days" id="formLeaveDays">
    <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- ‚úÖ TH√äM: Modal x√°c nh·∫≠n reset ph√©p nƒÉm -->
<div class="modal fade" id="resetLeaveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset ng√†y ph√©p nƒÉm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ mu·ªën reset ng√†y ph√©p nƒÉm v·ªÅ 0 cho <strong id="resetLeaveEmployeeName"></strong>?</p>
        <p class="text-muted">T·∫•t c·∫£ ng√†y ph√©p nƒÉm ƒë√£ s·ª≠ d·ª•ng s·∫Ω ƒë∆∞·ª£c kh√¥i ph·ª•c v·ªÅ 0.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kh√¥ng</button>
        <button type="button" class="btn btn-danger" id="confirmResetLeave">C√≥, reset</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ TH√äM: Form ·∫©n ƒë·ªÉ reset ph√©p nƒÉm -->
<form id="resetLeaveForm" method="POST" action="{{ url_for('main.reset_paid_leave') }}" style="display: none;">
    <input type="hidden" name="employee_id" id="resetLeaveEmployeeId">
    <input type="hidden" name="period" id="resetLeavePeriod">
    <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- ‚úÖ C·∫¨P NH·∫¨T: Form ·∫©n ƒë·ªÉ submit ƒëi·ªÅu ch·ªânh -->
<form id="adjustmentForm" method="POST" action="{{ url_for('main.apply_adjustment') }}" style="display: none;">
  <input type="hidden" name="employee_code" id="formEmployeeCode">
  <input type="hidden" name="period" id="formPeriod">
  <input type="hidden" name="original_days" id="formOriginalDays">
  <input type="hidden" name="overtime_hours" id="formOvertimeHours">
  <input type="hidden" name="current_absence" id="formCurrentAbsence">
  <input type="hidden" name="filename" id="formFilename" value="{{ filename }}">
</form>

<!-- ‚úÖ Form reset -->
<form id="resetForm" method="POST" action="{{ url_for('main.reset_adjustment_payroll') }}" style="display: none;">
  <input type="hidden" name="employee_code" id="resetEmployeeCode">
  <input type="hidden" name="period" id="resetPeriod">
  <input type="hidden" name="filename" value="{{ filename }}">
</form>


<!-- ‚úÖ THAY ƒê·ªîI: ƒê·∫∑t script TR∆Ø·ªöC khi s·ª≠ d·ª•ng trong HTML -->
<script src="{{ url_for('static', filename='js/attendance_print.js') }}"></script>
<script src="{{ url_for('static', filename='js/remaining_leave.js') }}"></script>

<!-- Xu·∫•t weekdays + day_count cho JS -->
<script id="timesheet-data" type="application/json">
{{ {"weekdays": weekdays|default({}), "day_count": day_count|default(31)} | tojson | safe }}
</script>

{% endblock %}