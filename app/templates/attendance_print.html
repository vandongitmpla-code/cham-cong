{% extends "base.html" %}

{% block title %}Bảng chấm công in ký{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/attendance_print.css') }}">
{% endblock %}

{% block content %}
  <!-- Nút in -->
  <div class="mb-3 text-end">
    <button class="btn btn-primary" onclick="window.print()">
      <i class="bi bi-printer"></i> In bảng
    </button>
  </div>

<div class="print-container">

  <!-- Thông tin công ty -->
  <table class="table table-borderless w-100 mb-1">
    <tr>
      <td class="text-start"><strong>Tên công ty:</strong> {{ company.name }}</td>
    </tr>
    <tr>
      <td class="text-start"><strong>Mã số thuế:</strong> {{ company.tax }}</td>
    </tr>
    <tr>
      <td class="text-start"><strong>Địa chỉ:</strong> {{ company.address }}</td>
    </tr>
    <tr>
      <td class="text-center fw-bold fs-6">{{ company.title }}</td>
    </tr>
  </table>

  <!-- Bảng chấm công -->
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          {% for col in cols %}
          <th>{{ col }}</th>
          {% endfor %}
          <th></th> {# Cột để hiển thị icon chi tiết, không có chữ #}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          {% for i in range(row|length - 1) %}
            {% set colname = cols[i] %}
            {% set cell = row[i] %}

            {% if colname == "Số ngày/giờ làm việc thực tế trong tháng" %}
            <td class="adjustable-cell position-relative" 
                style="min-width: 120px; cursor: pointer;"
                onmouseenter="showAdjustmentButtons(this)" 
                onmouseleave="hideAdjustmentButtons(this)">
              
              {{ cell }}
    
              <div class="adjustment-buttons" style="display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%);">
                
                <!-- ✅ NÚT "+" - CHỈ HIỆN KHI CHƯA ĐIỀU CHỈNH VÀ CÓ TĂNG CA -->
                {% if row[-1].has_overtime and not row[-1].has_adjustment %}
                <i class="bi bi-plus-circle-fill text-success me-1 adjustment-icon"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Gộp ngày tăng ca"
                  style="cursor:pointer; font-size: 16px;"
                  data-employee-code="{{ row[1] }}"
                  data-employee-name="{{ row[2] }}"
                  data-period="{{ period }}"
                  data-original-days="{{ row[-1].original_days }}"
                  data-actual-days="{{ cell }}"
                  data-overtime-hours="{{ row[-1].tang_ca_nghi_ban_dau }}"
                  data-current-absence="{{ row[-1].ngay_vang_ban_dau }}"
                  data-standard-days="{{ row[-1].standard_days or 26 }}"
                  data-ngay-nghi-phep-nam="{{ row[-1].ngay_nghi_phep_nam_da_dung }}">  <!-- ✅ THÊM THUỘC TÍNH NÀY -->
                </i>
                {% endif %}
                
                <!-- ✅ NÚT "-" - CHỈ HIỆN KHI ĐÃ ĐIỀU CHỈNH -->
                {% if row[-1].has_adjustment %}
                <i class="bi bi-dash-circle-fill text-danger reset-icon"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Khôi phục dữ liệu gốc"
                  style="cursor:pointer; font-size: 16px;"
                  data-employee-code="{{ row[1] }}"
                  data-employee-name="{{ row[2] }}"
                  data-period="{{ period }}"
                  data-filename="{{ filename }}">
                </i>
                {% endif %}
                
              </div>
            </td>

            {% elif colname == "Số ngày nghỉ phép năm" %}
            <!-- ✅ CỘT PHÉP NĂM VỚI ICON "+" VÀ "-" -->
            <td class="position-relative leave-cell" 
                style="min-width: 120px; cursor: pointer;"
                onmouseenter="showLeaveButtons(this)" 
                onmouseleave="hideLeaveButtons(this)">
              
              <span class="leave-days">{{ cell }}</span>
              
              <div class="leave-buttons" style="display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%);">
    
              <!-- ✅ NÚT "+" - LUÔN HIỆN KHI CÓ QUYỀN SỬ DỤNG PHÉP -->
              {% if row[-1].so_thang_duoc_huong > 0 %}
              <i class="bi bi-plus-circle-fill text-success me-1 leave-add-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Thêm ngày phép năm"
                style="cursor:pointer; font-size: 16px;"
                data-employee-id="{{ row[-1].employee_id }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-max-leave="{{ row[-1].so_thang_duoc_huong }}"
                data-current-leave="{{ cell }}"
                data-current-absence="{{ row[-1].ngay_vang_ban_dau }}"
                data-filename="{{ filename }}">
              </i>
              {% endif %}
              
              <!-- ✅ NÚT "-" - CHỈ HIỆN KHI ĐÃ CÓ PHÉP NĂM -->
              {% if cell > 0 %}
              <i class="bi bi-dash-circle-fill text-danger leave-reset-icon"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Reset ngày phép năm"
                style="cursor:pointer; font-size: 16px;"
                data-employee-id="{{ row[-1].employee_id }}"
                data-employee-name="{{ row[2] }}"
                data-period="{{ period }}"
                data-filename="{{ filename }}">
              </i>
              {% endif %}
          </div>
            </td>

            {% elif colname == "Số ngày nghỉ không lương" %}
            <td class="fw-bold absence-cell" 
                data-bs-toggle="tooltip" 
                data-bs-placement="top"
                title="Công thức: {{ row[-1].ngay_vang_ban_dau }} (gốc) - {{ row[-1].ngay_nghi_phep_nam_da_dung }} (phép năm) - {{ (row[-1].adjustment_info // 8) if row[-1].has_adjustment else 0 }} (tăng ca bù) = {{ cell }}">
                {{ cell }}
            </td>

            {% elif colname == "Bắt đầu tính phép từ tháng" %}
              <!-- ✅ CỘT THÁNG BẮT ĐẦU TÍNH PHÉP -->
              <td class="text-info fw-bold">
                {{ cell }}
              </td>

            {% elif colname == "Số ngày phép còn tồn" %}
              <!-- ✅ CỘT SỐ NGÀY PHÉP CÒN LẠI -->
              <td class="text-success fw-bold">
                {{ cell }}
              </td>

            {% elif colname in ["Số giờ làm việc tăng ca (ngày nghỉ hàng tuần)", 
                               "Số giờ làm việc tăng ca (ngày lễ)",
                               "Số giờ làm việc tăng ca (ngày làm trong tuần)"] %}
              <!-- Các cột giờ tăng ca - hiển thị nổi bật -->
              <td class="fw-bold text-primary">
                {{ cell }}
              </td>

            {% elif colname == "Ghi chú" %}
              <td class="note-cell" data-emp="{{ row[1] }}">
                {% if cell == "ICON_ONLY" or (cell is string and cell.endswith("|||ICON")) %}
                  {% if cell != "ICON_ONLY" %}
                    {{ cell.replace("|||ICON", "") }}
                  {% endif %}
                  <i class="bi bi-pencil-square text-primary ms-1 note-icon"
                    title="Thêm ghi chú"
                    style="cursor:pointer;"></i>
                  <input type="text"
                        class="note-input form-control form-control-sm mt-1 d-none"
                        placeholder="Nhập ghi chú...">
                {% else %}
                  {{ cell }}
                {% endif %}
              </td>

            {% else %}
              <td>{{ cell }}</td>
            {% endif %}
          {% endfor %}

          {# Cột icon chi tiết #}
          <td>
            <i class="bi bi-eye text-info btn-detail"
              style="cursor:pointer;"
              data-emp='{{ row[-1] | tojson | safe }}'
              title="Xem chi tiết"></i>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ✅ THÊM: Phần giải thích công thức -->
  <div class="mt-3 p-3 bg-light border rounded">
    <h6>Giải thích công thức:</h6>
    <ul class="small mb-0">
      <li><strong>Ngày công thực tế</strong> = Ngày công gốc + Phép năm đã dùng + Tăng ca đã bù</li>
      <li><strong>Ngày nghỉ cuối</strong> = Ngày nghỉ gốc - Phép năm đã dùng - Tăng ca đã bù</li>
      <li><strong>Giới hạn:</strong> Ngày công thực tế không vượt quá ngày công chuẩn</li>
    </ul>
  </div>
</div>

<!-- Modal chi tiết -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h3 id="modalTitle"></h3>
    <div id="modalTableWrapper"></div>
  </div>
</div>

<!-- ✅ CẬP NHẬT: Modal xác nhận gộp tăng ca với thông tin đầy đủ -->
<div class="modal fade" id="adjustmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gộp ngày tăng ca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có muốn gộp giờ tăng ca chủ nhật vào ngày công cho <strong id="modalEmployeeName"></strong>?</p>
        
        <div class="adjustment-details">
          <table class="table table-sm">
            <tr>
              <td><strong>Ngày công hiện tại:</strong></td>
              <td id="modalCurrentDays"></td>
            </tr>
            <tr>
              <td><strong>Ngày nghỉ hiện tại:</strong></td>
              <td id="modalCurrentAbsence"></td>
            </tr>
            <tr>
              <td><strong>Phép năm đã dùng:</strong></td>
              <td id="modalPhepNamUsed"></td>
            </tr>
            <tr>
              <td><strong>Giờ tăng ca có thể gộp:</strong></td>
              <td id="modalOvertimeHours"></td>
            </tr>
            <tr class="table-success">
              <td><strong>Ngày công sau gộp:</strong></td>
              <td id="modalAdjustedDays" class="text-success fw-bold"></td>
            </tr>
            <tr class="table-info">
              <td><strong>Ngày nghỉ sau gộp:</strong></td>
              <td id="modalNewAbsence" class="text-info fw-bold"></td>
            </tr>
            <tr class="table-warning">
              <td><strong>Giờ tăng ca còn lại:</strong></td>
              <td id="modalRemainingHours" class="text-warning fw-bold"></td>
            </tr>
          </table>
        </div>
        
        <div class="alert alert-info mt-3">
          <small>
            <strong>Công thức:</strong> Ngày công cuối = Ngày công ban đầu + Phép năm + Tăng ca bù<br>
            <strong>Giới hạn:</strong> Không vượt quá ngày công chuẩn ({{ rows[0][-1].standard_days if rows else 26 }} ngày)
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
        <button type="button" class="btn btn-primary" id="confirmAdjustment">Có, áp dụng</button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ BỔ SUNG: Modal xác nhận reset -->
<div class="modal fade" id="resetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Khôi phục dữ liệu gốc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có muốn khôi phục dữ liệu gốc cho <strong id="resetEmployeeName"></strong>?</p>
        <p class="text-muted">Dữ liệu điều chỉnh sẽ bị xóa và khôi phục về trạng thái ban đầu.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
        <button type="button" class="btn btn-danger" id="confirmReset">Có, khôi phục</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal thêm phép năm -->
<div class="modal fade" id="leaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm ngày phép năm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Nhân viên: <strong id="leaveEmployeeName"></strong></p>
                <div class="mb-3">
                    <label class="form-label">Số ngày phép năm sử dụng:</label>
                    <input type="number" class="form-control" id="leaveDaysInput" 
                           step="0.5" min="0" max="0">
                    <div class="form-text">Số ngày tối đa có thể sử dụng: <span id="maxLeaveDays">0</span> ngày</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmLeave">Xong</button>
            </div>
        </div>
    </div>
</div>

<!-- Form ẩn cho phép năm -->
<form id="leaveForm" method="POST" action="{{ url_for('main.add_paid_leave') }}" style="display: none;">
    <input type="hidden" name="employee_id" id="formEmployeeId">
    <input type="hidden" name="period" id="formLeavePeriod">
    <input type="hidden" name="leave_days" id="formLeaveDays">
    <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- ✅ THÊM: Modal xác nhận reset phép năm -->
<div class="modal fade" id="resetLeaveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset ngày phép năm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có muốn reset ngày phép năm về 0 cho <strong id="resetLeaveEmployeeName"></strong>?</p>
        <p class="text-muted">Tất cả ngày phép năm đã sử dụng sẽ được khôi phục về 0.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
        <button type="button" class="btn btn-danger" id="confirmResetLeave">Có, reset</button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ THÊM: Form ẩn để reset phép năm -->
<form id="resetLeaveForm" method="POST" action="{{ url_for('main.reset_paid_leave') }}" style="display: none;">
  <input type="hidden" name="employee_id" id="resetLeaveEmployeeId">
  <input type="hidden" name="period" id="resetLeavePeriod">
  <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- ✅ CẬP NHẬT: Form ẩn để submit điều chỉnh -->
<form id="adjustmentForm" method="POST" action="{{ url_for('main.apply_adjustment') }}" style="display: none;">
  <input type="hidden" name="employee_code" id="formEmployeeCode">
  <input type="hidden" name="period" id="formPeriod">
  <input type="hidden" name="original_days" id="formOriginalDays">
  <input type="hidden" name="overtime_hours" id="formOvertimeHours">
  <input type="hidden" name="current_absence" id="formCurrentAbsence">
  <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- ✅ Form reset -->
<form id="resetForm" method="POST" action="{{ url_for('main.reset_adjustment_payroll') }}" style="display: none;">
  <input type="hidden" name="employee_code" id="resetEmployeeCode">
  <input type="hidden" name="period" id="resetPeriod">
  <input type="hidden" name="filename" value="{{ filename }}">
</form>

<!-- Xuất weekdays + day_count cho JS -->
<script id="timesheet-data" type="application/json">
{{ {"weekdays": weekdays|default({}), "day_count": day_count|default(31)} | tojson | safe }}
</script>

<!-- ✅ THAY ĐỔI: Load JavaScript riêng thay vì inline -->
<script src="{{ url_for('static', filename='js/attendance_print.js') }}"></script>

{% endblock %}