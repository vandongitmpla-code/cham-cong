{% extends "base.html" %}
{% block title %}Upload File{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/upload.css') }}">
{% endblock %}

{% block content %}
<div class="row">
  <!-- Upload chấm công -->
  <div class="col-md-6">
    <div class="upload-card">
      <div class="title">Upload file từ máy chấm công</div>
      <div class="subtitle">Chỉ chấp nhận .xls, .xlsx — kéo thả hoặc chọn file</div>

      <form method="post" action="{{ url_for('main.upload') }}" enctype="multipart/form-data" id="uploadForm" class="mt-3">
        <label class="file-drop" id="fileDrop">
          <div class="icon"><i class="bi bi-cloud-arrow-up"></i></div>
          <div class="hint">Kéo file vào đây hoặc nhấp để chọn file</div>
          <input type="file" name="file" id="fileInput" class="file-input" accept=".xls,.xlsx" required>
          <a class="file-label" onclick="document.getElementById('fileInput').click()">Chọn file</a>
        </label>

        <div class="file-meta" id="fileMeta" style="display:none;">
          <div class="name" id="fileName"></div>
          <div class="size" id="fileSize"></div>
        </div>

        <div class="upload-actions">
          <button type="submit" class="btn-upload">Upload</button>
          <a href="{{ url_for('main.index') }}" class="btn-cancel">Hủy</a>
        </div>
        <div id="uploadMsg" class="upload-msg"></div>
      </form>
    </div>
  </div>

  <!-- Import nhân viên -->
  <div class="col-md-6">
    <div class="upload-card">
      <div class="title">Thêm nhân viên mới</div>
      <div class="subtitle">Chỉ chấp nhận .xls, .xlsx — kéo thả hoặc chọn file</div>

      <form method="post" action="{{ url_for('main.import_employees') }}" enctype="multipart/form-data" id="importForm" class="mt-3">
        <label class="file-drop" id="fileDropEmp">
          <div class="icon"><i class="bi bi-person-lines-fill"></i></div>
          <div class="hint">Kéo file vào đây hoặc nhấp để chọn file</div>
          <input type="file" name="file" id="fileInputEmp" class="file-input" accept=".xls,.xlsx" required>
          <a class="file-label" onclick="document.getElementById('fileInputEmp').click()">Chọn file</a>
        </label>

        <div class="file-meta" id="fileMetaEmp" style="display:none;">
          <div class="name" id="fileNameEmp"></div>
          <div class="size" id="fileSizeEmp"></div>
        </div>

        <div class="upload-actions">
          <button type="submit" class="btn-upload">Import</button>
          <a href="{{ url_for('main.employees') }}" class="btn-view">Xem danh sách</a>
        </div>

        <div id="importMsg" class="upload-msg"></div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  const fileInput = document.getElementById('fileInput');
  const fileDrop = document.getElementById('fileDrop');
  const fileMeta = document.getElementById('fileMeta');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');

  function humanSize(bytes){
    if(bytes < 1024) return bytes + ' B';
    if(bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1024/1024).toFixed(2) + ' MB';
  }

  fileDrop.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', (e) => {
    const f = e.target.files[0];
    if(!f) return;
    fileMeta.style.display = 'flex';
    fileName.textContent = f.name;
    fileSize.textContent = humanSize(f.size);
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(evt => {
    fileDrop.addEventListener(evt, (e)=>{ e.preventDefault(); fileDrop.classList.add('dragover'); });
  });
  ['dragleave','drop'].forEach(evt => {
    fileDrop.addEventListener(evt, (e)=>{ e.preventDefault(); fileDrop.classList.remove('dragover'); });
  });
  fileDrop.addEventListener('drop', (e)=>{
    const dt = e.dataTransfer;
    if(!dt) return;
    const f = dt.files[0];
    if(!f) return;
    fileInput.files = dt.files; // set file input
    fileMeta.style.display = 'flex';
    fileName.textContent = f.name;
    fileSize.textContent = humanSize(f.size);
  });
</script>
<script>
document.getElementById("fileInput").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;

  let formData = new FormData();
  formData.append("file", file);

  fetch("{{ url_for('main.preview_excel') }}", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      document.getElementById("previewBox").innerHTML =
        `<div class="text-danger">Lỗi: ${data.error}</div>`;
    } else {
      let html = `<table class="table table-bordered table-sm"><thead><tr>`;
      data.cols.forEach(c => html += `<th>${c}</th>`);
      html += `</tr></thead><tbody>`;
      data.rows.forEach(r => {
        html += "<tr>";
        data.cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      document.getElementById("previewBox").innerHTML = html;
    }
  });
});
</script>

<div id="previewBox" class="mt-3"></div>


{% endblock %}
