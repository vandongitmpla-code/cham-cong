{% extends "base.html" %}
{% block title %}Bảng chấm công in ký{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timesheet.css') }}">
{% endblock %}

{% block content %}
<div class="timesheet-wrapper">
  <!-- Header Section -->
  <div class="timesheet-header">
    <div class="timesheet-header-content">
      <h1 class="timesheet-title">Bảng chấm công bằng máy</h1>
      <div class="timesheet-period">
        <i class="bi bi-calendar-week"></i>
        <strong>Kỳ công:</strong> {{ att_meta.period if att_meta.period else "Chưa xác định" }}
      </div>
    </div>
    
    <div class="timesheet-info">
      <div class="timesheet-filename">
        <i class="bi bi-file-earmark-excel"></i>
        {{ filename }}
      </div>
      <div class="timesheet-stats">
        <span class="badge bg-primary">{{ rows|length }} nhân viên</span>
        <span class="badge bg-success">{{ day_count }} ngày</span>
      </div>
    </div>
  </div>

  <!-- Actions Section -->
  <div class="timesheet-actions">
    <a href="{{ url_for('main.payroll', filename=filename) }}" class="btn btn-report-primary">
      <i class="bi bi-calculator"></i> Bảng công tính lương
    </a>

    <form method="POST" action="{{ url_for('main.import_timesheet', filename=filename) }}" class="ms-2">
      <button type="submit" class="btn btn-report-success">
        <i class="bi bi-database-add"></i> Import vào Database
      </button>
    </form>
    
    <a href="{{ url_for('main.index') }}" class="btn btn-report-secondary">
      <i class="bi bi-arrow-left"></i> Quay lại Upload
    </a>
  </div>

  <!-- Table Controls -->
  <div class="timesheet-controls">
    <div class="control-group">
      <span class="control-label">Tìm kiếm:</span>
      <input type="text" class="control-select" id="searchInput" placeholder="Tìm theo tên, mã, phòng ban...">
    </div>
    <div class="control-group">
      <span class="control-label">Hiển thị:</span>
      <select class="control-select" id="rowCountSelect">
        <option value="50">50 dòng</option>
        <option value="100">100 dòng</option>
        <option value="all">Tất cả</option>
      </select>
    </div>
  </div>

  <!-- Table Container -->
  <div class="timesheet-table-container">
    <table class="timesheet-table">
      <thead>
        <tr>
          <th>Chi tiết</th>
          {% for col in cols %}
            {% if col in ['Mã', 'Tên', 'Phòng ban'] %}
              <th>{{ col }}</th>
            {% else %}
              <th title="{{ weekdays.get(col|int, '') }}">{{ col }}<br><small>{{ weekdays.get(col|int, '') }}</small></th>
            {% endif %}
          {% endfor %}
        </tr>
      </thead>
      <tbody id="timesheetBody">
        {% for row in rows %}
        <tr class="employee-row">
          <!-- Detail Button -->
          <td>
            <button 
              class="btn-detail"
              data-emp='{{ 
                {
                  "Mã": row[0], 
                  "Tên": row[1], 
                  "Phòng ban": row[2], 
                  "days": row[3:],
                  "weekdays": weekdays
                } | tojson 
              }}'
              title="Xem chi tiết chấm công">
              <i class="bi bi-eye"></i>
            </button>
          </td>
          
          <!-- Data Cells -->
          <!-- Trong phần table body - cập nhật cell rendering -->
{% for cell in row %}
<td class="{% if loop.index0 >= 3 %}day-cell{% endif %}">
  {% if loop.index0 >= 3 %} {# Day columns start from index 3 #}
    {% if cell %}
      {% if '<br>' in cell %}
        {# Multiple time entries - hiển thị nguyên bản với line breaks #}
        <div class="time-entries" style="font-size: 0.8rem; line-height: 1.2;">
          {{ cell|safe }}
        </div>
      {% elif cell in ['P', 'C', 'X'] %}
        <span class="status-present">{{ cell }}</span>
      {% elif cell in ['A', 'V', 'N'] %}
        <span class="status-absent">{{ cell }}</span>
      {% elif cell in ['L', 'D'] %}
        <span class="status-late">{{ cell }}</span>
      {% else %}
        {# Hiển thị nguyên bản cho các giá trị khác #}
        {{ cell|safe }}
      {% endif %}
    {% else %}
      {# Empty cell - absent #}
      <span class="status-absent">A</span>
    {% endif %}
  {% else %}
    {# Employee info columns #}
    {{ cell|safe }}
  {% endif %}
</td>
{% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Summary Section -->
  <div class="timesheet-summary">
    <div class="summary-stats">
      <div class="summary-stat">
        <div class="summary-number">{{ rows|length }}</div>
        <div class="summary-label">Tổng nhân viên</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number">{{ day_count }}</div>
        <div class="summary-label">Ngày làm việc</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number">{{ period[:7] if period else "N/A" }}</div>
        <div class="summary-label">Tháng</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number" id="presentCount">-</div>
        <div class="summary-label">Có mặt hôm nay</div>
      </div>
    </div>
  </div>
</div>

<!-- Employee Detail Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết chấm công</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="employeeDetailContent">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-report-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Employee detail modal functionality
  const detailButtons = document.querySelectorAll('.btn-detail');
  const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
  const detailContent = document.getElementById('employeeDetailContent');

  detailButtons.forEach(button => {
    button.addEventListener('click', function() {
      const empData = JSON.parse(this.getAttribute('data-emp'));
      
      // Calculate statistics
      const totalDays = empData.days.length;
      const presentDays = empData.days.filter(day => day && day !== '' && !day.includes('A') && !day.includes('V')).length;
      const absentDays = empData.days.filter(day => day && (day.includes('A') || day.includes('V'))).length;
      const lateDays = empData.days.filter(day => day && (day.includes('L') || day.includes('D'))).length;
      
      // Create modal content
      let content = `
        <div class="employee-detail">
          <div class="detail-header">
            <h4>${empData.Tên}</h4>
            <div class="detail-meta">
              <span class="badge bg-primary">${empData.Mã}</span>
              <span class="badge bg-secondary">${empData['Phòng ban']}</span>
            </div>
          </div>
          
          <div class="detail-stats">
            <div class="stat-item">
              <span class="stat-label">Tổng ngày:</span>
              <span class="stat-value">${totalDays}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Có mặt:</span>
              <span class="stat-value text-success">${presentDays}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Vắng:</span>
              <span class="stat-value text-danger">${absentDays}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Đi muộn:</span>
              <span class="stat-value text-warning">${lateDays}</span>
            </div>
          </div>
          
          <div class="detail-days">
            <h6>Chi tiết từng ngày:</h6>
            <div class="days-grid">
      `;
      
      empData.days.forEach((day, index) => {
        const dayNumber = index + 1;
        const weekday = empData.weekdays && empData.weekdays[dayNumber] ? empData.weekdays[dayNumber] : '';
        
        let dayClass = 'day-absent';
        let dayIcon = '❌';
        let dayTitle = `Ngày ${dayNumber}${weekday ? ' - ' + weekday : ''}: Vắng`;
        
        if (day && day !== '') {
          if (day.includes('A') || day.includes('V')) {
            dayClass = 'day-absent';
            dayIcon = '❌';
            dayTitle = `Ngày ${dayNumber}${weekday ? ' - ' + weekday : ''}: Vắng (${day})`;
          } else if (day.includes('L') || day.includes('D')) {
            dayClass = 'day-late';
            dayIcon = '⚠️';
            dayTitle = `Ngày ${dayNumber}${weekday ? ' - ' + weekday : ''}: Đi muộn (${day})`;
          } else if (day.includes('<br>')) {
            dayClass = 'day-present';
            dayIcon = '✅';
            dayTitle = `Ngày ${dayNumber}${weekday ? ' - ' + weekday : ''}: Có mặt - ${day.replace(/<br>/g, ', ')}`;
          } else {
            dayClass = 'day-present';
            dayIcon = '✅';
            dayTitle = `Ngày ${dayNumber}${weekday ? ' - ' + weekday : ''}: Có mặt (${day})`;
          }
        }
        
        content += `
          <div class="day ${dayClass}" title="${dayTitle}">
            <div class="day-number">${dayNumber}</div>
            <div class="day-icon">${dayIcon}</div>
            <div class="day-status">${day || 'A'}</div>
          </div>
        `;
      });
      
      content += `
            </div>
          </div>
        </div>
      `;
      
      detailContent.innerHTML = content;
      employeeModal.show();
    });
  });

  // Search functionality
  const searchInput = document.getElementById('searchInput');
  const timesheetBody = document.getElementById('timesheetBody');
  const employeeRows = document.querySelectorAll('.employee-row');

  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      
      employeeRows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }

  // Row count selector
  const rowCountSelect = document.getElementById('rowCountSelect');
  if (rowCountSelect) {
    rowCountSelect.addEventListener('change', function() {
      // Implementation for row count filtering
      console.log('Selected row count:', this.value);
    });
  }

  // Calculate present count for today
  function calculatePresentCount() {
    const today = new Date().getDate();
    let presentCount = 0;
    
    employeeRows.forEach(row => {
      const dayCells = row.querySelectorAll('.day-cell');
      if (dayCells.length >= today) {
        const todayCell = dayCells[today - 1];
        if (todayCell && !todayCell.querySelector('.status-absent')) {
          presentCount++;
        }
      }
    });
    
    document.getElementById('presentCount').textContent = presentCount;
  }
  
  // Calculate present count on load
  calculatePresentCount();

  // Add loading state when importing
  const importForm = document.querySelector('form[action*="import_timesheet"]');
  if (importForm) {
    importForm.addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang import...';
      submitBtn.disabled = true;
    });
  }
});
</script>

{% endblock %}
