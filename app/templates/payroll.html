{% extends "base.html" %}
{% block title %}Bảng công tính lương{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/payroll.css') }}">
{% endblock %}

{% block content %}
<div class="payroll-wrapper">
  <!-- Header Section -->
  <div class="payroll-header">
    <div class="payroll-header-content">
      <h1 class="payroll-title">Bảng công tính lương</h1>
      <div class="payroll-period">
        <i class="bi bi-calendar-week"></i>
        <strong>Kỳ công:</strong> {{ period if period else "Chưa xác định" }}
      </div>
    </div>
    
    <div class="payroll-info">
      <div class="timesheet-filename">
        <i class="bi bi-file-earmark-excel"></i>
        {{ filename }}
      </div>
    </div>
  </div>

  <!-- Actions Section -->
  <div class="payroll-actions">
    <!-- Nút Ngày Lễ Tết -->
    <button id="btnHolidays" class="btn-payroll btn-payroll-warning" data-bs-toggle="modal" data-bs-target="#holidayModal">
      <i class="bi bi-calendar-event"></i> Ngày Lễ tết
    </button>

    <!-- Nút Chấm công in ký -->
    <a href="{{ url_for('main.attendance_print', filename=filename) }}" class="btn-payroll btn-payroll-success">
      <i class="bi bi-printer"></i> Chấm công in ký
    </a>

    <!-- Nút Import Database -->
    <form method="POST" action="{{ url_for('main.import_payroll', filename=filename) }}">
      <button type="submit" class="btn-payroll btn-payroll-primary">
        <i class="bi bi-database-add"></i> Import vào Database
      </button>
    </form>
  </div>

  <!-- Holidays Section -->
  {% if holidays %}
  <div class="holidays-section">
    <h6 class="holidays-title">
      <i class="bi bi-calendar-event"></i> Danh sách ngày lễ đã nhập:
    </h6>
    <div class="holidays-list">
      {% for h in holidays %}
        <div class="holiday-item">
          <div>
            <span class="holiday-date">{{ h.date.strftime("%d/%m/%Y") }}</span>
            <span class="holiday-name"> - {{ h.name or "Không tên" }}</span>
          </div>
          <form method="POST" action="{{ url_for('main.delete_holiday', holiday_id=h.id, filename=filename) }}" style="display: inline;">
            <button type="submit" class="btn-holiday-delete">
              <i class="bi bi-trash"></i> Xóa
            </button>
          </form>
        </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="holidays-section">
    <h6 class="holidays-title">
      <i class="bi bi-calendar-event"></i> Danh sách ngày lễ
    </h6>
    <p class="text-muted mb-0">Chưa có ngày lễ nào.</p>
  </div>
  {% endif %}

  <!-- Table Container -->
  <div class="payroll-table-container">
    <table class="payroll-table">
      <thead>
        <!-- Header: tên cột -->
        <tr>
          {% for col in cols %}
            {% if col in ["Ngày công", "Ngày vắng", "Chủ nhật", "Lễ, tết"] %}
              <th class="highlight-col">{{ col }}</th>
            {% else %}
              <th>{{ col }}</th>
            {% endif %}
          {% endfor %}
        </tr>

        <!-- Header: thứ -->
        <tr>
          {% for col in cols %}
            {% if col.isdigit() %}
              {% set d = col|int %}
              {% set wd = weekdays.get(d, "") %}
              <th class="{% if d in holiday_days %}highlight-holiday{% elif wd and ('chủ' in wd|lower or 'cn' in wd|lower) %}highlight-sunday{% endif %}">
                {{ wd }}
              </th>
            {% elif col in ["Ngày công","Ngày vắng","Chủ nhật","Lễ, tết"] %}
              <th></th>
            {% else %}
              <th></th>
            {% endif %}
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for row in rows %}
          <tr>
            {% for i in range(cols|length) %}
              {% set colname = cols[i] %}
              {% set cell = row[i] %}
              {% if colname in ["Ngày công", "Ngày vắng", "Chủ nhật", "Lễ, tết"] %}
                <td class="highlight-col fw-bold">{{ cell }}</td>
              {% elif colname.isdigit() %}
                {% set d = colname|int %}
                {% set wd = weekdays.get(d, "") %}
                <td class="{% if d in holiday_days %}highlight-holiday{% elif wd and ('chủ' in wd|lower or 'cn' in wd|lower) %}highlight-sunday{% endif %}">
                  {% if cell == 'warn' %}
                    <i class="bi bi-exclamation-triangle-fill text-warning blink-icon blink-red"
                       data-bs-toggle="tooltip"
                       data-bs-placement="top"
                       data-bs-title="Chỉ có 1 lần chấm công, cần kiểm tra lại"></i>
                  {% else %}
                    {{ cell }}
                  {% endif %}
                </td>
              {% else %}
                <td>{{ cell }}</td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Holiday Modal -->
<div class="modal fade holiday-modal" id="holidayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm ngày lễ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('main.add_holiday') }}?filename={{ filename }}">
        <div class="modal-body">
          <div class="input-group">
            <input type="date" name="holiday_date" class="form-control" required>
            <input type="text" name="holiday_name" class="form-control" placeholder="Tên ngày lễ (VD: Quốc khánh)">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-payroll btn-payroll-primary">Lưu ngày lễ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tooltip khởi tạo -->
<script>
document.addEventListener("DOMContentLoaded", function(){
  const els = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  els.forEach(e => new bootstrap.Tooltip(e, {container: 'body'}));
  
  // Add loading state when importing
  const importForm = document.querySelector('form[action*="import_payroll"]');
  if (importForm) {
    importForm.addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang import...';
      submitBtn.disabled = true;
    });
  }
});
</script>
{% endblock %}